services:
  vault:
    image: hashicorp/vault:latest
    restart: always
    ports:
      - 8200
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_API_ADDR: ${VAULT_API_ADDR}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
    networks:
      - dokploy-network
    volumes:
      - ./vault/config:/vault/config
      - ./vault/data:/vault/data
      - ./vault/config/vault-sa.json:/vault/config/vault-sa.json
    command: vault server -config /vault/config/vault.hcl

  redis:
    image: redis:alpine
    restart: always
    ports:
      - 6379
    networks:
      - dokploy-network

  backend:
    build: .
    restart: always
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000
    depends_on:
      - redis
      - celery_gmail
      - celery_telegram
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
      - VAULT_ADDR=${VAULT_ADDR}
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`backendsearch.fahdbahri.com`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certResolver=letsencrypt"
      - "traefik.http.routers.backend.loadbalancer.server.port=8000"
  
  celery_gmail:
    build: .
    restart: always
    command: uv run celery -A services.celery_config:celery_app worker --pool=threads --concurrency=30 -Q gmail_process --loglevel=info
    depends_on:
      - redis
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
      - VAULT_ADDR=${VAULT_ADDR}
    networks:
      - dokploy-network

  celery_telegram:
    build: .
    restart: always
    command: uv run celery -A services.celery_config:celery_app worker --pool=threads --concurrency=30 -Q telegram_process --loglevel=info
    depends_on:
      - redis
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
      - VAULT_ADDR=${VAULT_ADDR}
    networks:
      - dokploy-network


networks:
  dokploy-network:
    external: true
    name: dokploy-network
